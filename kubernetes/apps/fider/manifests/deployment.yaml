# Fider - Feedback Portal (User-facing)
# Requires PostgreSQL database
#
# SETUP INSTRUCTIONS:
# After first deployment:
#
# 1. Create tenant with user-friendly name:
#    - Name: "Smadja.dev Feedback"
#    - Subdomain: feedback
#
# 2. Create TAGS for categorization:
#    - "Bug" (color: red)
#    - "Feature" (color: blue)
#    - "Question" (color: green)
#
# 3. DO NOT create tags for technical issues
#    Technical bugs â†’ GitHub Issues instead
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fider
  namespace: fider
  labels:
    app: fider
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fider
  template:
    metadata:
      labels:
        app: fider
      annotations:
        reloader.stakater.com/auto: "true"
    spec:
      containers:
        - name: fider
          image: getfider/fider:0.21.1
          ports:
            - containerPort: 3000
              name: http
          env:
            # Base URL (public)
            - name: BASE_URL
              value: "https://feedback.smadja.dev"

            # Database connection
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: fider-secrets
                  key: database-url

            # JWT Secret
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: fider-secrets
                  key: jwt-secret

            # Email (optional - can use Keycloak later)
            - name: EMAIL_NOREPLY
              value: "noreply@smadja.dev"

            # Disable email for now (use OAuth)
            - name: EMAIL_SMTP_HOST
              value: ""

            # OAuth with Keycloak (optional)
            # - name: OAUTH_KEYCLOAK_CLIENT_ID
            #   value: "fider"
            # - name: OAUTH_KEYCLOAK_SECRET
            #   valueFrom:
            #     secretKeyRef:
            #       name: fider-secrets
            #       key: keycloak-secret
            # - name: OAUTH_KEYCLOAK_URL
            #   value: "https://auth.smadja.dev/realms/homelab"

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 256Mi
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: fider
  namespace: fider
  labels:
    app: fider
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
      name: http
  selector:
    app: fider
