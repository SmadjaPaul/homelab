apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflared-config
  namespace: cloudflared
data:
  config.yaml: |
    tunnel: 5825ee88-3939-4e16-ab32-856c6ff7df96
    credentials-file: /etc/cloudflared/credentials/credentials.json
    metrics: 0.0.0.0:2000
    no-autoupdate: true

    # NOTE: The actual tunnel ingress config is managed by Terraform
    # (cloudflare_zero_trust_tunnel_cloudflared_config) and pushed via
    # the Cloudflare API. This ConfigMap is kept in sync for documentation.
    #
    # Traffic flow:
    #   1. home.smadja.dev -> https://traefik.traefik.svc.cluster.local:443 -> homepage
    #   2. proxmox.smadja.dev -> https://192.168.68.51:8006
    #   3. *.smadja.dev (catch-all) -> https://traefik.traefik.svc.cluster.local:443
    #      Traefik then routes via Ingress rules to: grafana, n8n, omni, etc.
    ingress:
      - hostname: home.smadja.dev
        originRequest:
          connectTimeout: 30s
          noTLSVerify: true
        service: https://traefik.traefik.svc.cluster.local:443
      - hostname: proxmox.smadja.dev
        originRequest:
          noTLSVerify: true
        service: https://192.168.68.51:8006
      # Catch-all: everything else goes to Traefik
      - service: https://traefik.traefik.svc.cluster.local:443
        originRequest:
          noTLSVerify: true
