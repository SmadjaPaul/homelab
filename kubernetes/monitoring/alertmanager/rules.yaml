# Custom Prometheus Alert Rules for Homelab
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: homelab-alerts
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    release: prometheus
spec:
  groups:
    # ==========================================================================
    # Infrastructure Alerts
    # ==========================================================================
    - name: infrastructure
      rules:
        # Node down
        - alert: NodeDown
          expr: up{job="node-exporter"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Node {{ $labels.instance }} is down"
            description: "Node has been unreachable for more than 5 minutes."

        # High CPU usage
        - alert: HighCpuUsage
          expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on {{ $labels.instance }}"
            description: "CPU usage is above 80% for more than 10 minutes. Current: {{ $value | printf \"%.1f\" }}%"

        # High memory usage
        - alert: HighMemoryUsage
          expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on {{ $labels.instance }}"
            description: "Memory usage is above 85%. Current: {{ $value | printf \"%.1f\" }}%"

        # Disk almost full
        - alert: DiskAlmostFull
          expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Disk almost full on {{ $labels.instance }}"
            description: "Disk {{ $labels.mountpoint }} is {{ $value | printf \"%.1f\" }}% full."

        - alert: DiskFull
          expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 95
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Disk full on {{ $labels.instance }}"
            description: "Disk {{ $labels.mountpoint }} is {{ $value | printf \"%.1f\" }}% full!"

    # ==========================================================================
    # Kubernetes Alerts
    # ==========================================================================
    - name: kubernetes
      rules:
        # Pod crash looping
        - alert: PodCrashLooping
          expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
            description: "Pod has restarted {{ $value | printf \"%.0f\" }} times in the last 15 minutes."

        # Pod not ready
        - alert: PodNotReady
          expr: kube_pod_status_ready{condition="true"} == 0
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
            description: "Pod has been in non-ready state for more than 10 minutes."

        # Deployment replicas mismatch
        - alert: DeploymentReplicasMismatch
          expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} replicas mismatch"
            description: "Expected {{ $value }} replicas but only {{ $labels.replicas_available }} available."

        # PVC almost full
        - alert: PVCAlmostFull
          expr: (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100 > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} almost full"
            description: "PVC is {{ $value | printf \"%.1f\" }}% full."

    # ==========================================================================
    # Application Alerts
    # ==========================================================================
    - name: applications
      rules:
        # Service down (generic)
        - alert: ServiceDown
          expr: up == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Service {{ $labels.job }} is down"
            description: "{{ $labels.instance }} has been down for more than 5 minutes."

        # ArgoCD app out of sync
        - alert: ArgoCDAppOutOfSync
          expr: argocd_app_info{sync_status!="Synced"} == 1
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "ArgoCD app {{ $labels.name }} is out of sync"
            description: "Application has been out of sync for more than 30 minutes."

        # ArgoCD app unhealthy
        - alert: ArgoCDAppUnhealthy
          expr: argocd_app_info{health_status!="Healthy"} == 1
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "ArgoCD app {{ $labels.name }} is unhealthy"
            description: "Application health status is {{ $labels.health_status }}."

    # ==========================================================================
    # Certificate Alerts
    # ==========================================================================
    - name: certificates
      rules:
        # Certificate expiring soon
        - alert: CertificateExpiringSoon
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 14
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.namespace }}/{{ $labels.name }} expiring soon"
            description: "Certificate expires in {{ $value | printf \"%.0f\" }} days."

        - alert: CertificateExpired
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) < 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Certificate {{ $labels.namespace }}/{{ $labels.name }} has expired!"
            description: "Certificate expired {{ $value | printf \"%.0f\" | mul -1 }} seconds ago."
