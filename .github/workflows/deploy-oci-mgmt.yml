# Deploy OCI Management Stack (Traefik + Cloudflared + Authentik + Omni)
# Déploie docker/oci-mgmt sur la VM OCI management uniquement (Ubuntu, pas Talos).
# SSH cible : oci_core_instance.management (Ubuntu). Les 2 nœuds Talos (k8s_node) ne sont jamais utilisés par ce workflow.
# Point d'entrée unique : Traefik (localhost:8080). Tunnel et Authentik : gérés par Terraform.
name: Deploy OCI Management Stack

on:
  push:
    branches: [main]
    paths:
      - 'docker/oci-mgmt/**'
      - 'ansible/**'
      - 'terraform/cloudflare/tunnel.tf'
      - 'terraform/authentik/**'
      - '.taskfiles/Taskfile.oci.yml'
      - 'Taskfile.yaml'
      - '.github/workflows/deploy-oci-mgmt.yml'
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run the deployment from"
        required: true
        default: "main"
        type: choice
        options:
          - main

concurrency:
  group: deploy-oci-mgmt
  cancel-in-progress: false

env:
  TF_WORKING_DIR: terraform/oracle-cloud
  TF_VERSION: '1.14.4'

jobs:
  get-mgmt-ip:
    name: Get management VM IP
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC token exchange
    outputs:
      mgmt_ip: ${{ steps.output.outputs.public_ip }}
      vm_exists: ${{ steps.output.outputs.vm_exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to OCI using OIDC
        id: oci-auth
        uses: ./.github/actions/oci-oidc-auth
        with:
          oci_tenancy_ocid: ${{ secrets.OCI_CLI_TENANCY }}
          oci_user_ocid: ${{ secrets.OCI_CLI_USER }}
          oci_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_region: ${{ secrets.OCI_CLI_REGION }}
          oci_api_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}

      - name: Configure OCI Authentication
        shell: bash
        env:
          OCI_SESSION_TOKEN: ${{ steps.oci-auth.outputs.oci_session_token }}
          OCI_SESSION_KEY: ${{ steps.oci-auth.outputs.oci_session_key }}
          AUTH_METHOD: ${{ steps.oci-auth.outputs.auth_method }}
        run: |
          mkdir -p ~/.oci

          if [[ "$AUTH_METHOD" == "oidc" && -n "$OCI_SESSION_TOKEN" ]]; then
            echo "Using OIDC authentication (UPST)"
            printf '%s\n' "$OCI_SESSION_TOKEN" > ~/.oci/session_token
            printf '%s\n' "$OCI_SESSION_KEY" > ~/.oci/session_key.pem
            chmod 600 ~/.oci/session_key.pem
            {
              echo "[DEFAULT]"
              echo "auth=security_token"
              echo "user=${{ secrets.OCI_CLI_USER }}"
              echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}"
              echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}"
              echo "region=${{ secrets.OCI_CLI_REGION }}"
              echo "security_token_file=${HOME}/.oci/session_token"
              echo "key_file=${HOME}/.oci/session_key.pem"
            } > ~/.oci/config
          else
            echo "Using API key authentication (fallback)"
            printf '%s\n' "${{ secrets.OCI_CLI_KEY_CONTENT }}" > ~/.oci/oci_api_key.pem
            chmod 600 ~/.oci/oci_api_key.pem
            {
              echo "[DEFAULT]"
              echo "user=${{ secrets.OCI_CLI_USER }}"
              echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}"
              echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}"
              echo "region=${{ secrets.OCI_CLI_REGION }}"
              echo "key_file=${HOME}/.oci/oci_api_key.pem"
            } > ~/.oci/config
          fi

      - name: Inject backend namespace (CI)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: sed -i.bak "s/YOUR_TENANCY_NAMESPACE/${{ secrets.OCI_OBJECT_STORAGE_NAMESPACE }}/g" backend.tf
      - name: Terraform Init (OCI backend)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -reconfigure

      - name: Terraform Output (management VM IP)
        id: output
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          IP=$(terraform output -json 2>/dev/null | jq -r '.management_vm.value.public_ip // empty')
          if [ -z "$IP" ]; then
            echo "::warning::Management VM not found. Run Terraform OCI apply first to create the VM."
            echo "public_ip=" >> $GITHUB_OUTPUT
            echo "vm_exists=false" >> $GITHUB_OUTPUT
          else
            echo "public_ip=$IP" >> $GITHUB_OUTPUT
            echo "vm_exists=true" >> $GITHUB_OUTPUT
            echo "Management VM IP: $IP"
          fi

  # SSH target = management VM only (Ubuntu, user ubuntu). Talos nodes have no SSH.
  deploy:
    name: Deploy Omni stack on VM
    runs-on: ubuntu-latest
    needs: get-mgmt-ip
    if: needs['get-mgmt-ip'].outputs.vm_exists == 'true'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache OCI CLI
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.home }}/lib/oracle-cli
            ${{ runner.home }}/bin
          key: oci-cli-${{ runner.os }}-v3

      - name: Add OCI CLI to PATH
        run: echo "${{ runner.home }}/bin" >> $GITHUB_PATH

      - name: Fetch secrets from OCI Vault
        id: secrets
        uses: ./.github/actions/oci-vault-secrets
        with:
          secrets: 'oci_mgmt_ssh_private_key,postgres_password,authentik_secret_key,cloudflare_tunnel_token'
          oci_cli_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_cli_user: ${{ secrets.OCI_CLI_USER }}
          oci_cli_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_cli_tenancy: ${{ secrets.OCI_CLI_TENANCY }}
          oci_cli_region: ${{ secrets.OCI_CLI_REGION }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}

      - name: Setup SSH key
        env:
          OCI_MGMT_SSH_KEY: ${{ steps.secrets.outputs.oci_mgmt_ssh_private_key }}
          OCI_MGMT_SSH_PRIVATE_KEY: ${{ secrets.OCI_MGMT_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          # Prefer GitHub secret so the key is guaranteed to match SSH_PUBLIC_KEY
          if [[ -n "$OCI_MGMT_SSH_PRIVATE_KEY" ]]; then
            echo "Using GitHub secret OCI_MGMT_SSH_PRIVATE_KEY."
            printf '%s\n' "$OCI_MGMT_SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/oci_mgmt.pem
          else
            KEY_FILE="${{ steps.secrets.outputs.oci_mgmt_ssh_private_key_file }}"
            if [[ -n "$KEY_FILE" && -f "$KEY_FILE" ]]; then
              cp "$KEY_FILE" ~/.ssh/oci_mgmt.pem
            else
              printf '%s\n' "$OCI_MGMT_SSH_KEY" | tr -d '\r' > ~/.ssh/oci_mgmt.pem
            fi
          fi
          chmod 600 ~/.ssh/oci_mgmt.pem
          KEY_LINES=$(wc -l < ~/.ssh/oci_mgmt.pem)
          if [[ "$KEY_LINES" -lt 2 ]]; then
            echo "::error::SSH key invalid (too few lines). Set repo secret OCI_MGMT_SSH_PRIVATE_KEY with the full PEM (same pair as SSH_PUBLIC_KEY)."
            exit 1
          fi
          if ! head -1 ~/.ssh/oci_mgmt.pem | grep -q -- '-----BEGIN'; then
            echo "Prepending missing -----BEGIN OPENSSH PRIVATE KEY----- line."
            { echo "-----BEGIN OPENSSH PRIVATE KEY-----"; cat ~/.ssh/oci_mgmt.pem; } > ~/.ssh/oci_mgmt.pem.new
            mv ~/.ssh/oci_mgmt.pem.new ~/.ssh/oci_mgmt.pem
            chmod 600 ~/.ssh/oci_mgmt.pem
          fi
          if ! ssh-keygen -y -f ~/.ssh/oci_mgmt.pem >/dev/null 2>&1; then
            echo "::error::Invalid SSH private key. Check OCI_MGMT_SSH_PRIVATE_KEY: full PEM with -----BEGIN and -----END, same pair as SSH_PUBLIC_KEY."
            exit 1
          fi
          ssh-keyscan -H ${{ needs['get-mgmt-ip'].outputs.mgmt_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Debug SSH connectivity
        run: |
          set +e
          IP="${{ needs['get-mgmt-ip'].outputs.mgmt_ip }}"
          echo "=== SSH debug (target: ubuntu@$IP) ==="
          echo "Key file: $(wc -l < ~/.ssh/oci_mgmt.pem) lines, first line: $(head -1 ~/.ssh/oci_mgmt.pem), last line: $(tail -1 ~/.ssh/oci_mgmt.pem)"
          echo "Testing SSH (verbose tail)..."
          SSH_ERR=$(ssh -v -o BatchMode=yes -o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/oci_mgmt.pem ubuntu@"$IP" "echo OK" 2>&1)
          SSH_EXIT=$?
          echo "--- Last 40 lines of SSH output ---"
          echo "$SSH_ERR" | tail -40
          echo "--- SSH exit code: $SSH_EXIT ---"
          if [[ $SSH_EXIT -ne 0 ]]; then
            echo "::warning::SSH test failed (exit $SSH_EXIT). If you see 'Permission denied (publickey)': the key in OCI Vault must be the PRIVATE key of the same pair as Terraform SSH_PUBLIC_KEY. If you see 'Connection refused' or timeout: check firewall (e.g. ALLOW_SSH_FROM_ANYWHERE or ADMIN_ALLOWED_CIDRS for GitHub IPs)."
          else
            echo "SSH test OK."
          fi

      - name: Install Ansible and collections
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Write Ansible extra vars (secrets)
        run: |
          {
            echo "cloudflare_tunnel_token: \"${{ steps.secrets.outputs.cloudflare_tunnel_token }}\""
            echo "postgres_password: \"${{ steps.secrets.outputs.postgres_password }}\""
            echo "authentik_secret_key: \"${{ steps.secrets.outputs.authentik_secret_key }}\""
          } > /tmp/oci-mgmt-ansible-vars.yml
          chmod 600 /tmp/oci-mgmt-ansible-vars.yml

      - name: Run Ansible playbook (deploy OCI management stack)
        run: |
          if ! ansible-playbook ansible/playbooks/oci-mgmt-deploy.yml \
            -i "oci_mgmt," \
            -e "ansible_host=${{ needs['get-mgmt-ip'].outputs.mgmt_ip }}" \
            -e "ansible_user=ubuntu" \
            -e "ansible_ssh_private_key_file=$HOME/.ssh/oci_mgmt.pem" \
            -e "project_root=${{ github.workspace }}" \
            -e "@/tmp/oci-mgmt-ansible-vars.yml"; then
            echo "::error::SSH failed. If 'Permission denied (publickey)': the key in OCI Vault (homelab-oci-mgmt-ssh-private-key) must be the PRIVATE key of the same key pair whose PUBLIC key is in Terraform (SSH_PUBLIC_KEY). Same pair = VM authorized_keys was set by Terraform with that public key."
            exit 1
          fi
        env:
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/ansible/roles

      - name: Verify deployment (containers + Traefik)
        run: |
          set -e
          IP="${{ needs['get-mgmt-ip'].outputs.mgmt_ip }}"
          SSH_OPTS="-o StrictHostKeyChecking=accept-new -i $HOME/.ssh/oci_mgmt.pem -l ubuntu"
          echo "Checking containers..."
          CONTAINERS=$(ssh $SSH_OPTS "$IP" "cd /home/ubuntu/homelab/oci-mgmt && docker compose ps -a --format '{{.Name}}'")
          for name in oci-mgmt-traefik oci-mgmt-cloudflared oci-mgmt-omni oci-mgmt-authentik-server oci-mgmt-postgres; do
            if echo "$CONTAINERS" | grep -q "$name"; then
              echo "  ✓ $name"
            else
              echo "  ✗ $name missing"
              exit 1
            fi
          done
          echo "Checking Traefik + backend (Authentik may take 30-60s to start)..."
          for i in {1..12}; do
            CODE=$(ssh $SSH_OPTS "$IP" "curl -s -o /dev/null -w '%{http_code}' --connect-timeout 10 -H 'Host: auth.smadja.dev' http://127.0.0.1:8080" || echo "000")
            if [[ "$CODE" =~ ^[23][0-9][0-9]$ ]]; then
              echo "  ✓ Traefik + backend respond (HTTP $CODE) after ${i} attempt(s)"
              break
            fi
            if [[ $i -eq 12 ]]; then
              echo "  ✗ Still HTTP $CODE after 12 attempts (Traefik up but backend may still be starting; check https://auth.smadja.dev in 1-2 min)"
              exit 1
            fi
            echo "  Attempt $i/12: HTTP $CODE, retrying in 10s..."
            sleep 10
          done
          echo "Deployment verified."

      - name: Remove secrets file
        if: always()
        run: rm -f /tmp/oci-mgmt-ansible-vars.yml
