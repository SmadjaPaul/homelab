# Deploy OCI Management Stack (Omni + PostgreSQL) — IaC via CI
# Déploie docker/oci-mgmt sur la VM management OCI (IP depuis Terraform state).
# Secrets are fetched from OCI Vault (not GitHub Secrets)
name: Deploy OCI Management Stack

on:
  push:
    branches: [main]
    paths:
      - 'docker/oci-mgmt/**'
      - '.github/workflows/deploy-oci-mgmt.yml'
  workflow_dispatch:

concurrency:
  group: deploy-oci-mgmt
  cancel-in-progress: false

env:
  TF_WORKING_DIR: terraform/oracle-cloud
  TF_VERSION: '1.14.4'

jobs:
  get-mgmt-ip:
    name: Get management VM IP
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC token exchange
    outputs:
      mgmt_ip: ${{ steps.output.outputs.public_ip }}
      vm_exists: ${{ steps.output.outputs.vm_exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to OCI using OIDC
        id: oci-auth
        uses: ./.github/actions/oci-oidc-auth
        with:
          oci_tenancy_ocid: ${{ secrets.OCI_CLI_TENANCY }}
          oci_user_ocid: ${{ secrets.OCI_CLI_USER }}
          oci_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_region: ${{ secrets.OCI_CLI_REGION }}
          oci_api_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}

      - name: Configure OCI Authentication
        shell: bash
        env:
          OCI_SESSION_TOKEN: ${{ steps.oci-auth.outputs.oci_session_token }}
          OCI_SESSION_KEY: ${{ steps.oci-auth.outputs.oci_session_key }}
          AUTH_METHOD: ${{ steps.oci-auth.outputs.auth_method }}
        run: |
          mkdir -p ~/.oci

          if [[ "$AUTH_METHOD" == "oidc" && -n "$OCI_SESSION_TOKEN" ]]; then
            echo "Using OIDC authentication (UPST)"
            printf '%s\n' "$OCI_SESSION_TOKEN" > ~/.oci/session_token
            printf '%s\n' "$OCI_SESSION_KEY" > ~/.oci/session_key.pem
            chmod 600 ~/.oci/session_key.pem
            {
              echo "[DEFAULT]"
              echo "auth=security_token"
              echo "user=${{ secrets.OCI_CLI_USER }}"
              echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}"
              echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}"
              echo "region=${{ secrets.OCI_CLI_REGION }}"
              echo "security_token_file=${HOME}/.oci/session_token"
              echo "key_file=${HOME}/.oci/session_key.pem"
            } > ~/.oci/config
          else
            echo "Using API key authentication (fallback)"
            printf '%s\n' "${{ secrets.OCI_CLI_KEY_CONTENT }}" > ~/.oci/oci_api_key.pem
            chmod 600 ~/.oci/oci_api_key.pem
            {
              echo "[DEFAULT]"
              echo "user=${{ secrets.OCI_CLI_USER }}"
              echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}"
              echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}"
              echo "region=${{ secrets.OCI_CLI_REGION }}"
              echo "key_file=${HOME}/.oci/oci_api_key.pem"
            } > ~/.oci/config
          fi

      - name: Inject backend namespace (CI)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: sed -i.bak "s/YOUR_TENANCY_NAMESPACE/${{ secrets.OCI_OBJECT_STORAGE_NAMESPACE }}/g" backend.tf
      - name: Terraform Init (OCI backend)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -reconfigure

      - name: Terraform Output (management VM IP)
        id: output
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          IP=$(terraform output -json 2>/dev/null | jq -r '.management_vm.value.public_ip // empty')
          if [ -z "$IP" ]; then
            echo "::warning::Management VM not found. Run Terraform OCI apply first to create the VM."
            echo "public_ip=" >> $GITHUB_OUTPUT
            echo "vm_exists=false" >> $GITHUB_OUTPUT
          else
            echo "public_ip=$IP" >> $GITHUB_OUTPUT
            echo "vm_exists=true" >> $GITHUB_OUTPUT
            echo "Management VM IP: $IP"
          fi

  deploy:
    name: Deploy Omni stack on VM
    runs-on: ubuntu-latest
    needs: get-mgmt-ip
    if: needs.get-mgmt-ip.outputs.vm_exists == 'true'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch secrets from OCI Vault
        id: secrets
        uses: ./.github/actions/oci-vault-secrets
        with:
          secrets: 'oci_mgmt_ssh_private_key,omni_db_user,omni_db_password,omni_db_name'
          oci_cli_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_cli_user: ${{ secrets.OCI_CLI_USER }}
          oci_cli_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_cli_tenancy: ${{ secrets.OCI_CLI_TENANCY }}
          oci_cli_region: ${{ secrets.OCI_CLI_REGION }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.secrets.outputs.oci_mgmt_ssh_private_key }}" > ~/.ssh/oci_mgmt.pem
          chmod 600 ~/.ssh/oci_mgmt.pem
          ssh-keyscan -H ${{ needs.get-mgmt-ip.outputs.mgmt_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Copy docker/oci-mgmt to VM
        run: |
          # Create target directory on VM first
          ssh -i ~/.ssh/oci_mgmt.pem -o StrictHostKeyChecking=accept-new ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }} 'mkdir -p ~/homelab'
          # Copy the docker compose files
          scp -i ~/.ssh/oci_mgmt.pem -r docker/oci-mgmt ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }}:~/homelab/

      - name: Create .env on VM
        env:
          OMNI_DB_USER: ${{ steps.secrets.outputs.omni_db_user }}
          OMNI_DB_PASSWORD: ${{ steps.secrets.outputs.omni_db_password }}
          OMNI_DB_NAME: ${{ steps.secrets.outputs.omni_db_name }}
        run: |
          printf 'OMNI_DB_USER=%s\nOMNI_DB_PASSWORD=%s\nOMNI_DB_NAME=%s\n' \
            "$OMNI_DB_USER" "$OMNI_DB_PASSWORD" "$OMNI_DB_NAME" > /tmp/oci-mgmt.env
          scp -i ~/.ssh/oci_mgmt.pem /tmp/oci-mgmt.env ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }}:~/homelab/oci-mgmt/.env
          rm -f /tmp/oci-mgmt.env

      - name: Docker Compose up
        run: |
          ssh -i ~/.ssh/oci_mgmt.pem ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }} \
            'cd ~/homelab/oci-mgmt && docker compose pull && docker compose up -d'

      - name: Verify
        run: |
          ssh -i ~/.ssh/oci_mgmt.pem ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }} \
            'cd ~/homelab/oci-mgmt && docker compose ps'
