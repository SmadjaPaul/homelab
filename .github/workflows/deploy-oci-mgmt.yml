# Deploy OCI Management Stack (Omni + PostgreSQL) — IaC via CI
# Déploie docker/oci-mgmt sur la VM management OCI (IP depuis Terraform state).
# Secrets are fetched from OCI Vault (not GitHub Secrets)
name: Deploy OCI Management Stack

on:
  push:
    branches: [main]
    paths:
      - 'docker/oci-mgmt/**'
      - '.github/workflows/deploy-oci-mgmt.yml'
  workflow_dispatch:

concurrency:
  group: deploy-oci-mgmt
  cancel-in-progress: false

env:
  TF_WORKING_DIR: terraform/oracle-cloud
  TF_VERSION: '1.11.0'

jobs:
  get-mgmt-ip:
    name: Get management VM IP
    runs-on: ubuntu-latest
    outputs:
      mgmt_ip: ${{ steps.output.outputs.public_ip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure OCI Session Token
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_SESSION_TOKEN }}" > ~/.oci/session_token
          echo "${{ secrets.OCI_SESSION_PRIVATE_KEY }}" > ~/.oci/session_key.pem
          chmod 600 ~/.oci/session_key.pem
          cat > ~/.oci/config << EOF
          [DEFAULT]
          auth=security_token
          user=${{ secrets.OCI_CLI_USER }}
          fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_CLI_TENANCY }}
          region=${{ secrets.OCI_CLI_REGION }}
          security_token_file=~/.oci/session_token
          key_file=~/.oci/session_key.pem
          EOF
          echo "OCI_CLI_AUTH=security_token" >> $GITHUB_ENV

      - name: Inject backend namespace (CI)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: sed -i.bak "s/YOUR_TENANCY_NAMESPACE/${{ secrets.OCI_OBJECT_STORAGE_NAMESPACE }}/g" backend.tf
      - name: Terraform Init (OCI backend)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -reconfigure

      - name: Terraform Output (management VM IP)
        id: output
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          IP=$(terraform output -json 2>/dev/null | jq -r '.management_vm.value.public_ip // empty')
          if [ -z "$IP" ]; then
            echo "::error::Terraform output 'management_vm.public_ip' not found. Run Terraform OCI apply first."
            exit 1
          fi
          echo "public_ip=$IP" >> $GITHUB_OUTPUT
          echo "Management VM IP: $IP"

  deploy:
    name: Deploy Omni stack on VM
    runs-on: ubuntu-latest
    needs: get-mgmt-ip
    if: needs.get-mgmt-ip.outputs.mgmt_ip != ''
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch secrets from OCI Vault
        id: secrets
        uses: ./.github/actions/oci-vault-secrets
        with:
          secrets: 'oci_mgmt_ssh_private_key,omni_db_user,omni_db_password,omni_db_name'
          oci_session_token: ${{ secrets.OCI_SESSION_TOKEN }}
          oci_session_private_key: ${{ secrets.OCI_SESSION_PRIVATE_KEY }}
          oci_cli_user: ${{ secrets.OCI_CLI_USER }}
          oci_cli_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_cli_tenancy: ${{ secrets.OCI_CLI_TENANCY }}
          oci_cli_region: ${{ secrets.OCI_CLI_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.secrets.outputs.oci_mgmt_ssh_private_key }}" > ~/.ssh/oci_mgmt.pem
          chmod 600 ~/.ssh/oci_mgmt.pem
          ssh-keyscan -H ${{ needs.get-mgmt-ip.outputs.mgmt_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Copy docker/oci-mgmt to VM
        run: |
          scp -i ~/.ssh/oci_mgmt.pem -o StrictHostKeyChecking=accept-new -r docker/oci-mgmt ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }}:~/homelab/

      - name: Create .env on VM
        env:
          OMNI_DB_USER: ${{ steps.secrets.outputs.omni_db_user }}
          OMNI_DB_PASSWORD: ${{ steps.secrets.outputs.omni_db_password }}
          OMNI_DB_NAME: ${{ steps.secrets.outputs.omni_db_name }}
        run: |
          printf 'OMNI_DB_USER=%s\nOMNI_DB_PASSWORD=%s\nOMNI_DB_NAME=%s\n' \
            "$OMNI_DB_USER" "$OMNI_DB_PASSWORD" "$OMNI_DB_NAME" > /tmp/oci-mgmt.env
          scp -i ~/.ssh/oci_mgmt.pem /tmp/oci-mgmt.env ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }}:~/homelab/oci-mgmt/.env
          rm -f /tmp/oci-mgmt.env

      - name: Docker Compose up
        run: |
          ssh -i ~/.ssh/oci_mgmt.pem ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }} \
            'cd ~/homelab/oci-mgmt && docker compose pull && docker compose up -d'

      - name: Verify
        run: |
          ssh -i ~/.ssh/oci_mgmt.pem ubuntu@${{ needs.get-mgmt-ip.outputs.mgmt_ip }} \
            'cd ~/homelab/oci-mgmt && docker compose ps'
