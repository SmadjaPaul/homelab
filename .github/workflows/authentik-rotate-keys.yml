# Rotate Authentik Private Key JWT Keys (Monthly)
# Generates new RSA keypair, updates Authentik JWKS, and stores new private key
# Runs monthly to rotate keys for security
name: Rotate Authentik Keys

on:
  schedule:
    # Run on the 1st of every month at 2 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      skip_verification:
        description: 'Skip verification after rotation'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: authentik-keys-rotation
  cancel-in-progress: false

jobs:
  rotate-keys:
    name: Rotate RSA Keys
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Authentik secrets from OCI Vault
        id: vault-secrets-old
        uses: ./.github/actions/oci-vault-secrets
        with:
          secrets: 'authentik_token,authentik_private_key_pem'
          oci_cli_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_cli_user: ${{ secrets.OCI_CLI_USER }}
          oci_cli_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_cli_tenancy: ${{ secrets.OCI_CLI_TENANCY }}
          oci_cli_region: ${{ secrets.OCI_CLI_REGION }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}
        continue-on-error: true

      - name: Generate New RSA Keypair
        id: keypair-new
        uses: ./.github/actions/generate-rsa-keypair

      - name: Configure OCI for Terraform backend
        env:
          OCI_CLI_KEY: ${{ secrets.OCI_CLI_KEY_CONTENT }}
        run: |
          mkdir -p ~/.oci
          printf '%s\n' "$OCI_CLI_KEY" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          {
            echo "[DEFAULT]"
            echo "user=${{ secrets.OCI_CLI_USER }}"
            echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}"
            echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}"
            echo "region=${{ secrets.OCI_CLI_REGION }}"
            echo "key_file=${HOME}/.oci/oci_api_key.pem"
          } > ~/.oci/config

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.14.4'

      - name: Inject backend namespace (CI)
        working-directory: terraform/authentik
        run: |
          if [ -f backend.tf ]; then
            # Replace any namespace value (including YOUR_TENANCY_NAMESPACE placeholder or existing value)
            # This ensures CI always uses the secret namespace, allowing shared state between local and CI
            sed -i.bak "s/namespace = \"[^\"]*\"/namespace = \"${{ secrets.OCI_OBJECT_STORAGE_NAMESPACE }}\"/g" backend.tf
          fi

      - name: Terraform Init
        working-directory: terraform/authentik
        run: terraform init -reconfigure

      - name: Get OAuth Source UUID from Terraform
        id: terraform-source
        working-directory: terraform/authentik
        run: |
          SOURCE_UUID=$(terraform output -raw ci_automation_oauth_source_uuid 2>/dev/null || echo "")
          if [ -z "$SOURCE_UUID" ] || [ "$SOURCE_UUID" == "null" ]; then
            echo "::error::Could not get OAuth Source UUID from Terraform"
            exit 1
          fi
          echo "source_uuid=$SOURCE_UUID" >> $GITHUB_OUTPUT

      - name: Get Current JWKS from Authentik
        id: current-jwks
        env:
          AUTHENTIK_URL: ${{ secrets.AUTHENTIK_URL || 'https://auth.smadja.dev' }}
          AUTHENTIK_TOKEN: ${{ steps.vault-secrets-old.outputs.authentik_token || secrets.AUTHENTIK_TOKEN }}
          SOURCE_UUID: ${{ steps.terraform-source.outputs.source_uuid }}
        run: |
          # Get current OAuth Source configuration
          SOURCE_CONFIG=$(curl -s -X GET \
            "${AUTHENTIK_URL}/api/v3/sources/oauth/${SOURCE_UUID}/" \
            -H "Authorization: Bearer ${AUTHENTIK_TOKEN}")

          CURRENT_JWKS=$(echo "$SOURCE_CONFIG" | jq -r '.jwks // "{}"')

          if [ "$CURRENT_JWKS" != "null" ] && [ "$CURRENT_JWKS" != "{}" ]; then
            echo "current_jwks<<EOF_JWKS" >> $GITHUB_OUTPUT
            echo "$CURRENT_JWKS" >> $GITHUB_OUTPUT
            echo "EOF_JWKS" >> $GITHUB_OUTPUT
            echo "::notice::Found existing JWKS, will add new key alongside old one"
          else
            echo "::notice::No existing JWKS found, creating new one"
          fi

      - name: Update Authentik OAuth Source with New JWKS
        env:
          AUTHENTIK_URL: ${{ secrets.AUTHENTIK_URL || 'https://auth.smadja.dev' }}
          AUTHENTIK_TOKEN: ${{ steps.vault-secrets-old.outputs.authentik_token || secrets.AUTHENTIK_TOKEN }}
          SOURCE_UUID: ${{ steps.terraform-source.outputs.source_uuid }}
          NEW_PUBLIC_KEY_JWK: ${{ steps.keypair-new.outputs.public_key_jwk }}
          CURRENT_JWKS: ${{ steps.current-jwks.outputs.current_jwks }}
        run: |
          # Build JWKS with new key (and keep old keys for transition period)
          if [ -n "$CURRENT_JWKS" ] && [ "$CURRENT_JWKS" != "{}" ] && [ "$CURRENT_JWKS" != "null" ]; then
            # Merge existing keys with new key
            NEW_KEY=$(echo "$NEW_PUBLIC_KEY_JWK" | jq '.')
            JWKS=$(echo "$CURRENT_JWKS" | jq --argjson newkey "$NEW_KEY" '.keys += [$newkey]')
          else
            # Create new JWKS with just the new key
            JWKS=$(echo "$NEW_PUBLIC_KEY_JWK" | jq '{keys: [.]}')
          fi

          echo "Updating Authentik OAuth Source with new JWKS..."

          RESPONSE=$(curl -s -X PATCH \
            "${AUTHENTIK_URL}/api/v3/sources/oauth/${SOURCE_UUID}/" \
            -H "Authorization: Bearer ${AUTHENTIK_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"jwks\": ${JWKS}}")

          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "unknown"')
            echo "::error::Failed to update OAuth Source: $ERROR"
            exit 1
          fi

          echo "✓ New public key added to Authentik JWKS"
          echo "::notice::Old keys are still valid for transition period"

      - name: Store New Private Key in OCI Vault
        uses: ./.github/actions/oci-vault-update-secret
        with:
          secret_name: 'homelab-authentik-private-key-pem'
          secret_value: ${{ steps.keypair-new.outputs.private_key_pem }}
          oci_cli_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_cli_user: ${{ secrets.OCI_CLI_USER }}
          oci_cli_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_cli_tenancy: ${{ secrets.OCI_CLI_TENANCY }}
          oci_cli_region: ${{ secrets.OCI_CLI_REGION }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}

      - name: Verify New Key Works
        if: github.event.inputs.skip_verification != 'true'
        id: verify-new-key
        uses: ./.github/actions/authentik-private-key-jwt-auth
        with:
          client_id: 'ci-automation'
          private_key_pem: ${{ steps.keypair-new.outputs.private_key_pem }}
          issuer_url: 'https://auth.smadja.dev/application/o/ci-automation/'

      - name: Verify New Key Authentication
        if: github.event.inputs.skip_verification != 'true' && steps.verify-new-key.outputs.token_source == 'private_key_jwt'
        env:
          AUTHENTIK_URL: ${{ secrets.AUTHENTIK_URL || 'https://auth.smadja.dev' }}
          ACCESS_TOKEN: ${{ steps.verify-new-key.outputs.access_token }}
        run: |
          echo "Verifying new key by testing API access..."
          RESPONSE=$(curl -s -X GET \
            "${AUTHENTIK_URL}/api/v3/core/users/me/" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" 2>/dev/null || echo '{"error":"request_failed"}')

          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "::warning::New key verification API call failed, but token was obtained"
          else
            echo "::notice::✓ New key verified - API access successful"
          fi

      - name: Cleanup Old Keys (after 7 days)
        continue-on-error: true
        run: |
          echo "::notice::Old keys will remain in JWKS for 7 days for transition"
          echo "::notice::Run this workflow again in 7 days to remove old keys, or remove manually via Authentik API"
          # TODO: Implement automatic cleanup after grace period

      - name: Summary
        run: |
          echo "::notice::✓ Key rotation completed successfully"
          echo "::notice::New private key stored in OCI Vault: homelab-authentik-private-key-pem"
          echo "::notice::New public key added to Authentik JWKS"
          echo "::notice::Old keys remain valid for 7 days (grace period)"
