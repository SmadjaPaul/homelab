# Validate Secrets Format and Presence
# Reusable workflow - can be called from other workflows
name: Validate Secrets

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'terraform/**'
      - 'scripts/**'
  workflow_call:
    secrets: inherit
  workflow_dispatch:
    inputs:
      check_github_secrets:
        description: 'Check GitHub secrets format'
        required: false
        default: true
        type: boolean
      check_oci_vault:
        description: 'Check OCI Vault secrets (requires OCI auth)'
        required: false
        default: false
        type: boolean

jobs:
  validate-github-secrets:
    name: Validate GitHub Secrets Format
    runs-on: ubuntu-latest
    if: github.event.inputs.check_github_secrets != 'false'
    permissions:
      contents: read
      secrets: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate SSH_PUBLIC_KEY format
        env:
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          if [[ -z "$SSH_PUBLIC_KEY" ]]; then
            echo "::error::SSH_PUBLIC_KEY secret is not set"
            exit 1
          fi

          if echo "$SSH_PUBLIC_KEY" | grep -q -- '-----BEGIN'; then
            echo "::error::SSH_PUBLIC_KEY contains a PRIVATE key. It must be the PUBLIC key (one line starting with ssh-ed25519 or ssh-rsa)"
            exit 1
          fi

          if ! echo "$SSH_PUBLIC_KEY" | grep -qE '^ssh-(ed25519|rsa|dss|ecdsa) '; then
            echo "::error::SSH_PUBLIC_KEY format invalid. Must be one line starting with ssh-ed25519 or ssh-rsa"
            exit 1
          fi

          echo "✅ SSH_PUBLIC_KEY format is valid"

      - name: Setup GitHub CLI
        uses: actions/setup-github-cli@v1

      - name: Check required GitHub secrets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REQUIRED_SECRETS=(
            "OCI_CLI_TENANCY"
            "OCI_CLI_USER"
            "OCI_CLI_FINGERPRINT"
            "OCI_CLI_REGION"
            "OCI_COMPARTMENT_ID"
            "OCI_OBJECT_STORAGE_NAMESPACE"
            "SSH_PUBLIC_KEY"
            "OCI_MGMT_SSH_PRIVATE_KEY"
          )

          MISSING=()
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if ! gh secret list --repo "${{ github.repository }}" | grep -q "^$secret"; then
              MISSING+=("$secret")
            fi
          done

          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo "::warning::Missing secrets: ${MISSING[*]}"
          else
            echo "✅ All required secrets are present"
          fi

  validate-oci-vault:
    name: Validate OCI Vault Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.check_oci_vault == 'true'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Authenticate to OCI
        id: oci-auth
        uses: ./.github/actions/oci-oidc-auth
        with:
          oci_tenancy_ocid: ${{ secrets.OCI_CLI_TENANCY }}
          oci_user_ocid: ${{ secrets.OCI_CLI_USER }}
          oci_fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          oci_region: ${{ secrets.OCI_CLI_REGION }}
          oci_api_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          oci_domain_url: ${{ secrets.OCI_DOMAIN_URL }}
          oci_client_id: ${{ secrets.OCI_OIDC_CLIENT_ID }}
          oci_client_secret: ${{ secrets.OCI_OIDC_CLIENT_SECRET }}

      - name: Check OCI Vault secrets
        env:
          TENANCY_ID: ${{ secrets.OCI_CLI_TENANCY }}
        run: |
          echo "Checking OCI Vault secrets..."

          REQUIRED_SECRETS=(
            "homelab-cloudflare-api-token"
            "homelab-oci-mgmt-ssh-private-key"
            "homelab-omni-db-user"
            "homelab-omni-db-password"
            "homelab-omni-db-name"
          )

          MISSING=()
          for secret_name in "${REQUIRED_SECRETS[@]}"; do
            SECRET_ID=$(oci vault secret list \
              --compartment-id "$TENANCY_ID" \
              --name "$secret_name" \
              --lifecycle-state ACTIVE \
              --all \
              --query 'data[0].id' \
              --raw-output 2>/dev/null || true)

            if [[ -z "$SECRET_ID" || "$SECRET_ID" == "null" ]]; then
              MISSING+=("$secret_name")
            else
              echo "✅ Found: $secret_name"
            fi
          done

          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo "::warning::Missing OCI Vault secrets: ${MISSING[*]}"
          else
            echo "✅ All required OCI Vault secrets are present"
          fi
