name: Manage - Secrets
# =====================
# Manages Doppler secrets - generate, rotate, or update

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'generate'
        type: choice
        options:
          - generate    # Generate all secrets
          - rotate      # Rotate specific secret
          - verify      # Verify secrets exist
      project:
        description: 'Project to rotate (only for rotate action)'
        required: false
        default: ''
        type: string
      secret_name:
        description: 'Secret name to rotate (only for rotate action)'
        required: false
        default: ''
        type: string

env:
  DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
  ROBUSTA_ACCOUNT_ID: ${{ secrets.ROBUSTA_ACCOUNT_ID }}
  ROBUSTA_SIGNING_KEY: ${{ secrets.ROBUSTA_SIGNING_KEY }}

jobs:
  # =============================================================================
  # Generate All Secrets
  # =============================================================================
  generate-secrets:
    name: Generate Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'generate' || github.event.inputs.action == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Terraform Init
        working-directory: terraform/secrets
        run: terraform init

      - name: Generate Secrets
        working-directory: terraform/secrets
        run: |
          terraform apply \
            -var="doppler_token=${{ secrets.DOPPLER_TOKEN }}" \
            -var="robusta_account_id=${{ secrets.ROBUSTA_ACCOUNT_ID }}" \
            -var="robusta_signing_key=${{ secrets.ROBUSTA_SIGNING_KEY }}" \
            -auto-approve

      - name: Summary
        run: |
          echo "## Secrets Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Generated and synchronized secrets to Doppler" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Projects updated:" >> $GITHUB_STEP_SUMMARY
          echo "- n8n" >> $GITHUB_STEP_SUMMARY
          echo "- opencloud" >> $GITHUB_STEP_SUMMARY
          echo "- infra-core" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next step: Deploy to Kubernetes" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Rotate Specific Secret
  # =============================================================================
  rotate-secret:
    name: Rotate Secret
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rotate'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Terraform Init
        working-directory: terraform/secrets
        run: terraform init

      - name: Rotate Secret
        working-directory: terraform/secrets
        run: |
          PROJECT="${{ github.event.inputs.project }}"
          SECRET="${{ github.event.inputs.secret_name }}"

          if [ -z "$PROJECT" ] || [ -z "$SECRET" ]; then
            echo "❌ Project and secret_name are required for rotation"
            exit 1
          fi

          echo "Rotating secret: $PROJECT/$SECRET"

          # Determine which random_password resource to rotate
          case "$SECRET" in
            "N8N_ENCRYPTION_KEY")
              RESOURCE="random_password.n8n_encryption_key"
              ;;
            "GRAFANA_ADMIN_PASSWORD")
              RESOURCE="random_password.grafana_admin_password"
              ;;
            "OPENCLOUD_ADMIN_PASSWORD")
              RESOURCE="random_password.opencloud_admin_password"
              ;;
            *)
              echo "❌ Unknown secret: $SECRET"
              exit 1
              ;;
          esac

          terraform apply \
            -var="doppler_token=${{ secrets.DOPPLER_TOKEN }}" \
            -var="robusta_account_id=${{ secrets.ROBUSTA_ACCOUNT_ID }}" \
            -var="robusta_signing_key=${{ secrets.ROBUSTA_SIGNING_KEY }}" \
            -replace="$RESOURCE" \
            -auto-approve

      - name: Summary
        run: |
          echo "## Secret Rotated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Rotated secret: ${{ github.event.inputs.project }}/${{ github.event.inputs.secret_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Applications using this secret will need to be restarted" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Verify Secrets
  # =============================================================================
  verify-secrets:
    name: Verify Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'verify'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Doppler CLI
        run: |
          (curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh || wget -t 3 -qO- https://cli.doppler.com/install.sh) | sh

      - name: Verify Secrets
        run: |
          PROJECTS=("n8n" "opencloud" "infra-core" "cloudflare" "robusta")

          echo "## Verifying Doppler Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for project in "${PROJECTS[@]}"; do
            echo "Checking project: $project"
            SECRETS=$(doppler secrets -p "$project" -c prod --json 2>/dev/null | jq -r '. | length')
            if [ "$SECRETS" -gt 0 ]; then
              echo "✅ $project: $SECRETS secrets found" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ $project: No secrets found" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verification complete. Check details above." >> $GITHUB_STEP_SUMMARY
