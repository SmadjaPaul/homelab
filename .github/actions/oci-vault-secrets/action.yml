# Composite action to fetch secrets from OCI Vault
# Usage in workflow:
#   - uses: ./.github/actions/oci-vault-secrets
#     id: secrets
#     with:
#       secrets: 'cloudflare_api_token'
#       oci_cli_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
#       ...
#   - run: echo "Token is ${{ steps.secrets.outputs.cloudflare_api_token }}"
#
# Requires OCI API key secrets already configured in GitHub.
name: 'Fetch OCI Vault Secrets'
description: 'Retrieves secrets from OCI Vault and exposes them as outputs'

inputs:
  secrets:
    description: 'Comma-separated list of secrets to fetch (e.g., cloudflare_api_token)'
    required: true
  oci_cli_key_content:
    description: 'OCI CLI API Key Content (PEM)'
    required: true
  oci_cli_user:
    description: 'OCI CLI User OCID'
    required: true
  oci_cli_fingerprint:
    description: 'OCI CLI Fingerprint'
    required: true
  oci_cli_tenancy:
    description: 'OCI CLI Tenancy OCID'
    required: true
  oci_cli_region:
    description: 'OCI CLI Region'
    required: true
    default: 'eu-paris-1'
  oci_domain_url:
    description: 'OCI Identity Domain URL (for OIDC)'
    required: false
    default: ''
  oci_client_id:
    description: 'OCI OIDC OAuth Client ID'
    required: false
    default: ''
  oci_client_secret:
    description: 'OCI OIDC OAuth Client Secret'
    required: false
    default: ''

outputs:
  cloudflare_api_token:
    description: 'Cloudflare API Token'
    value: ${{ steps.fetch.outputs.cloudflare_api_token }}
  # DEPRECATED: TFstate.dev backend no longer used (migrated to OCI Object Storage)
  # tfstate_dev_token:
  #   description: 'TFstate.dev / GitHub PAT'
  #   value: ${{ steps.fetch.outputs.tfstate_dev_token }}
  omni_db_user:
    description: 'Omni DB User'
    value: ${{ steps.fetch.outputs.omni_db_user }}
  omni_db_password:
    description: 'Omni DB Password'
    value: ${{ steps.fetch.outputs.omni_db_password }}
  omni_db_name:
    description: 'Omni DB Name'
    value: ${{ steps.fetch.outputs.omni_db_name }}
  oci_mgmt_ssh_private_key:
    description: 'OCI Management SSH Private Key (prefer oci_mgmt_ssh_private_key_file for multiline PEM)'
    value: ${{ steps.fetch.outputs.oci_mgmt_ssh_private_key }}
  oci_mgmt_ssh_private_key_file:
    description: 'Path to PEM file (use this to avoid env newline issues)'
    value: ${{ steps.fetch.outputs.oci_mgmt_ssh_private_key_file }}
  # OCI Management Stack secrets
  cloudflare_tunnel_token:
    description: 'Cloudflare Tunnel Token for cloudflared'
    value: ${{ steps.fetch.outputs.cloudflare_tunnel_token }}
  postgres_password:
    description: 'PostgreSQL password for OCI management stack'
    value: ${{ steps.fetch.outputs.postgres_password }}
  authentik_secret_key:
    description: 'Authentik secret key for session encryption'
    value: ${{ steps.fetch.outputs.authentik_secret_key }}

runs:
  using: 'composite'
  steps:
    - name: Install OCI CLI
      shell: bash
      run: |
        if ! command -v oci &> /dev/null; then
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
        fi

    - name: Configure OCI CLI
      uses: ./.github/actions/oci-config
      with:
        oci_cli_key_content: ${{ inputs.oci_cli_key_content }}
        oci_cli_user: ${{ inputs.oci_cli_user }}
        oci_cli_fingerprint: ${{ inputs.oci_cli_fingerprint }}
        oci_cli_tenancy: ${{ inputs.oci_cli_tenancy }}
        oci_cli_region: ${{ inputs.oci_cli_region }}
        oci_domain_url: ${{ inputs.oci_domain_url }}
        oci_client_id: ${{ inputs.oci_client_id }}
        oci_client_secret: ${{ inputs.oci_client_secret }}

    - name: Fetch secrets from OCI Vault
      id: fetch
      shell: bash
      run: |
        declare -A SECRET_NAMES=(
          ["cloudflare_api_token"]="homelab-cloudflare-api-token"
          ["omni_db_user"]="homelab-omni-db-user"
          ["omni_db_password"]="homelab-omni-db-password"
          ["omni_db_name"]="homelab-omni-db-name"
          ["oci_mgmt_ssh_private_key"]="homelab-oci-mgmt-ssh-private-key"
          ["cloudflare_tunnel_token"]="homelab-cloudflare-tunnel-token"
          ["postgres_password"]="homelab-postgres-password"
          ["authentik_secret_key"]="homelab-authentik-secret-key"
        )

        IFS=',' read -ra REQUESTED <<< "${{ inputs.secrets }}"

        for secret_key in "${REQUESTED[@]}"; do
          secret_key=$(echo "$secret_key" | xargs)
          secret_name="${SECRET_NAMES[$secret_key]}"

          [[ -z "$secret_name" ]] && { echo "::warning::Unknown secret: $secret_key"; continue; }

          SECRET_OCID=$(oci vault secret list \
            --compartment-id "${{ inputs.oci_cli_tenancy }}" \
            --name "$secret_name" \
            --lifecycle-state ACTIVE \
            --all \
            --query 'data[0].id' \
            --raw-output 2>/dev/null || true)

          [[ -z "$SECRET_OCID" || "$SECRET_OCID" == "null" ]] && { echo "::warning::Secret not found: $secret_name"; continue; }

          SECRET_VALUE=$(oci secrets secret-bundle get \
            --secret-id "$SECRET_OCID" \
            --stage CURRENT \
            --query 'data."secret-bundle-content".content' \
            --raw-output 2>/dev/null || true)

          [[ -z "$SECRET_VALUE" || "$SECRET_VALUE" == "null" ]] && { echo "::warning::Could not retrieve: $secret_name"; continue; }

          DECODED=$(echo "$SECRET_VALUE" | base64 -d)
          [[ -z "$DECODED" ]] && { echo "::error::Secret $secret_name is empty"; exit 1; }

          echo "::add-mask::$DECODED"

          # SSH key: write to file
          if [[ "$secret_key" == "oci_mgmt_ssh_private_key" ]]; then
            SSH_KEY_FILE="${GITHUB_WORKSPACE}/.tmp/oci_mgmt_ssh_key.pem"
            mkdir -p "$(dirname "$SSH_KEY_FILE")"
            echo "$DECODED" | sed 's/\\n/\n/g' | tr -d '\r' > "$SSH_KEY_FILE"
            [[ ! $(head -1 "$SSH_KEY_FILE") =~ ^-----BEGIN ]] && \
              { echo "-----BEGIN OPENSSH PRIVATE KEY-----"; cat "$SSH_KEY_FILE"; } > "${SSH_KEY_FILE}.tmp" && \
              mv "${SSH_KEY_FILE}.tmp" "$SSH_KEY_FILE"
            chmod 600 "$SSH_KEY_FILE"
            echo "oci_mgmt_ssh_private_key_file=$SSH_KEY_FILE" >> "$GITHUB_OUTPUT"
          fi

          # Output format
          if echo "$DECODED" | grep -q $'\n'; then
            echo "${secret_key}<<EOF_${secret_key}" >> "$GITHUB_OUTPUT"
            echo "$DECODED" >> "$GITHUB_OUTPUT"
            echo "EOF_${secret_key}" >> "$GITHUB_OUTPUT"
          else
            DECODED_TRIMMED=$(echo "$DECODED" | tr -d '\n\r' | xargs)
            [[ "$secret_key" == "cloudflare_api_token" ]] && \
              { [[ ${#DECODED_TRIMMED} -ne 40 ]] || ! echo "$DECODED_TRIMMED" | grep -qE '^[a-zA-Z0-9_-]{40}$'; } && \
              { echo "::error::Invalid Cloudflare token format"; exit 1; }
            echo "${secret_key}=$DECODED_TRIMMED" >> "$GITHUB_OUTPUT"
          fi
        done
