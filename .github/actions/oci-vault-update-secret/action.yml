# Composite action to update an OCI Vault secret
# Usage in workflow:
#   - uses: ./.github/actions/oci-vault-update-secret
#     with:
#       secret_name: 'homelab-authentik-oauth2-client-id'
#       secret_value: ${{ steps.terraform.outputs.ci_client_id }}
#       oci_cli_key_content: ${{ secrets.OCI_CLI_KEY_CONTENT }}
#       ...
#
# Requires OCI API key secrets already configured in GitHub.
name: 'Update OCI Vault Secret'
description: 'Updates an existing OCI Vault secret with new content'

inputs:
  secret_name:
    description: 'Name of the secret in OCI Vault (e.g., homelab-authentik-oauth2-client-id)'
    required: true
  secret_value:
    description: 'New secret value to store (will be base64 encoded)'
    required: true
  oci_cli_key_content:
    description: 'OCI CLI API Key Content (PEM)'
    required: true
  oci_cli_user:
    description: 'OCI CLI User OCID'
    required: true
  oci_cli_fingerprint:
    description: 'OCI CLI Fingerprint'
    required: true
  oci_cli_tenancy:
    description: 'OCI CLI Tenancy OCID'
    required: true
  oci_cli_region:
    description: 'OCI CLI Region'
    required: true
    default: 'eu-paris-1'
  oci_domain_url:
    description: 'OCI Identity Domain URL (for OIDC)'
    required: false
    default: ''
  oci_client_id:
    description: 'OCI OIDC OAuth Client ID'
    required: false
    default: ''
  oci_client_secret:
    description: 'OCI OIDC OAuth Client Secret'
    required: false
    default: ''

outputs:
  secret_ocid:
    description: 'OCID of the updated secret'
    value: ${{ steps.update.outputs.secret_ocid }}
  updated:
    description: 'Whether the secret was updated (true) or created (false)'
    value: ${{ steps.update.outputs.updated }}

runs:
  using: 'composite'
  steps:
    - name: Install OCI CLI
      shell: bash
      run: |
        if ! command -v oci &> /dev/null; then
          echo "Installing OCI CLI..."
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
        fi

    - name: Authenticate to OCI using OIDC
      id: oci-auth
      uses: ./.github/actions/oci-oidc-auth
      with:
        oci_tenancy_ocid: ${{ inputs.oci_cli_tenancy }}
        oci_user_ocid: ${{ inputs.oci_cli_user }}
        oci_fingerprint: ${{ inputs.oci_cli_fingerprint }}
        oci_region: ${{ inputs.oci_cli_region }}
        oci_api_key_content: ${{ inputs.oci_cli_key_content }}
        oci_domain_url: ${{ inputs.oci_domain_url }}
        oci_client_id: ${{ inputs.oci_client_id }}
        oci_client_secret: ${{ inputs.oci_client_secret }}

    - name: Configure OCI Authentication
      shell: bash
      env:
        OCI_SESSION_TOKEN: ${{ steps.oci-auth.outputs.oci_session_token }}
        OCI_SESSION_KEY: ${{ steps.oci-auth.outputs.oci_session_key }}
        AUTH_METHOD: ${{ steps.oci-auth.outputs.auth_method }}
      run: |
        mkdir -p ~/.oci

        if [[ "$AUTH_METHOD" == "oidc" && -n "$OCI_SESSION_TOKEN" ]]; then
          echo "Using OIDC authentication (UPST) for Vault access"
          printf '%s\n' "$OCI_SESSION_TOKEN" > ~/.oci/session_token
          printf '%s\n' "$OCI_SESSION_KEY" > ~/.oci/session_key.pem
          chmod 600 ~/.oci/session_key.pem
          {
            echo "[DEFAULT]"
            echo "auth=security_token"
            echo "user=${{ inputs.oci_cli_user }}"
            echo "fingerprint=${{ inputs.oci_cli_fingerprint }}"
            echo "tenancy=${{ inputs.oci_cli_tenancy }}"
            echo "region=${{ inputs.oci_cli_region }}"
            echo "security_token_file=${HOME}/.oci/session_token"
            echo "key_file=${HOME}/.oci/session_key.pem"
          } > ~/.oci/config
        else
          echo "Using API key authentication (fallback) for Vault access"
          printf '%s\n' "${{ inputs.oci_cli_key_content }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          {
            echo "[DEFAULT]"
            echo "user=${{ inputs.oci_cli_user }}"
            echo "fingerprint=${{ inputs.oci_cli_fingerprint }}"
            echo "tenancy=${{ inputs.oci_cli_tenancy }}"
            echo "region=${{ inputs.oci_cli_region }}"
            echo "key_file=${HOME}/.oci/oci_api_key.pem"
          } > ~/.oci/config
        fi

        # Fix permissions to avoid warnings
        chmod 600 ~/.oci/config
        if [[ -f ~/.oci/oci_api_key.pem ]]; then
          chmod 600 ~/.oci/oci_api_key.pem
        fi
        if [[ -f ~/.oci/session_key.pem ]]; then
          chmod 600 ~/.oci/session_key.pem
        fi

        # Suppress file permissions warning
        export OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True

    - name: Install jq
      shell: bash
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq || true
        fi

    - name: Get Vault and Key OCIDs
      id: vault-config
      shell: bash
      env:
        COMPARTMENT_ID: ${{ inputs.oci_cli_tenancy }}
        OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: True
      run: |
        # Install jq if not available
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq || true
        fi

        # Try Terraform state first (most reliable if available)
        echo "Trying Terraform state first..."
        VAULT_ID=""
        KEY_ID=""

        # Try to find terraform directory
        TF_DIR=""
        for dir in terraform/oracle-cloud ../../terraform/oracle-cloud .; do
          if [[ -f "$dir/terraform.tfstate" ]] || [[ -f "$dir/.terraform/terraform.tfstate" ]]; then
            TF_DIR="$dir"
            break
          fi
        done

        if [[ -n "$TF_DIR" ]]; then
          echo "Found Terraform directory: $TF_DIR"
          cd "$TF_DIR" || true

          # Try to get from Terraform outputs
          if command -v terraform &> /dev/null; then
            VAULT_OUTPUT=$(terraform output -json vault_secrets 2>/dev/null || echo "")
            if [[ -n "$VAULT_OUTPUT" ]]; then
              VAULT_ID=$(echo "$VAULT_OUTPUT" | jq -r '.vault_id // empty' 2>/dev/null || echo "")
              KEY_ID=$(echo "$VAULT_OUTPUT" | jq -r '.key_id // empty' 2>/dev/null || echo "")

              # key_id is not in vault_secrets output, need to get from state or resource
              if [[ -z "$KEY_ID" || "$KEY_ID" == "null" ]]; then
                # Try terraform state show
                KEY_STATE=$(terraform state show oci_kms_key.homelab_secrets_key 2>/dev/null || echo "")
                if [[ -n "$KEY_STATE" ]]; then
                  KEY_ID=$(echo "$KEY_STATE" | grep '^\s*id\s*=' | head -1 | awk -F'"' '{print $2}' || echo "")
                fi

                # If still not found, try reading state file directly
                if [[ -z "$KEY_ID" || "$KEY_ID" == "null" ]]; then
                  if [[ -f terraform.tfstate ]]; then
                    KEY_ID=$(jq -r '.resources[]? | select(.type == "oci_kms_key" and (.name == "homelab_secrets_key" or .name == "homelab-secrets-key")) | .instances[0].attributes.id // empty' terraform.tfstate 2>/dev/null | head -1 || echo "")
                  fi
                fi
              fi
            fi
          fi

          # Try reading from state file directly
          if [[ -z "$VAULT_ID" || "$VAULT_ID" == "null" ]]; then
            if [[ -f terraform.tfstate ]]; then
              VAULT_ID=$(jq -r '.resources[]? | select(.type == "oci_kms_vault") | .instances[0].attributes.id // empty' terraform.tfstate 2>/dev/null | head -1 || echo "")
              KEY_ID=$(jq -r '.resources[]? | select(.type == "oci_kms_key") | .instances[0].attributes.id // empty' terraform.tfstate 2>/dev/null | head -1 || echo "")
            fi
          fi
        fi

        # Fallback: try OCI API if Terraform state failed
        if [[ -z "$VAULT_ID" || -z "$KEY_ID" || "$VAULT_ID" == "null" || "$KEY_ID" == "null" ]]; then
          echo "::notice::Terraform state not available, trying OCI API..."

          # Test OCI CLI authentication first
          echo "Testing OCI CLI authentication..."
          OCI_TEST=$(oci iam region list --raw-output 2>&1) || true
          if echo "$OCI_TEST" | grep -q "Usage:\|error\|Error\|401\|403"; then
            echo "::error::OCI CLI authentication failed. Check credentials."
            echo "Test output: ${OCI_TEST:0:300}..."
            exit 1
          fi

          # Get vault by name (try multiple name variations)
          echo "Listing vaults in compartment $COMPARTMENT_ID..."
          # Suppress warnings and separate stderr from stdout
          # Try to get clean JSON first (stderr redirected)
          VAULT_LIST_OUTPUT=$(oci kms management vault list \
            --compartment-id "$COMPARTMENT_ID" \
            --all \
            --raw-output 2>/dev/null || echo "")
          VAULT_LIST_EXIT=$?

          # If that failed or output is empty, try with stderr included and filter warnings
          if [[ "$VAULT_LIST_EXIT" -ne 0 ]] || [[ -z "$VAULT_LIST_OUTPUT" ]]; then
            VAULT_LIST_OUTPUT=$(oci kms management vault list \
              --compartment-id "$COMPARTMENT_ID" \
              --all \
              --raw-output 2>&1 | grep -v "^WARNING:" | grep -v "^To fix" | grep -v "^Alternatively" | grep -v "^export OCI_CLI" | grep -v "^oci setup repair" || true)
            VAULT_LIST_EXIT=$?
          fi

          # Extract JSON from output (find the JSON object, remove any leading warnings)
          VAULT_LIST_JSON=$(echo "$VAULT_LIST_OUTPUT" | grep -E '^\s*\{' -A 1000 | head -100 | jq -c '.' 2>/dev/null || echo "$VAULT_LIST_OUTPUT" | jq -c '.' 2>/dev/null || echo "")

          # If still empty, try to find JSON anywhere in output
          if [[ -z "$VAULT_LIST_JSON" ]]; then
            VAULT_LIST_JSON=$(echo "$VAULT_LIST_OUTPUT" | jq -c '.' 2>/dev/null || echo "")
          fi

          # Check if command succeeded (look for JSON structure)
          if [[ "$VAULT_LIST_EXIT" -eq 0 ]] && echo "$VAULT_LIST_JSON" | jq -e '.data' > /dev/null 2>&1; then
            # Parse vault ID from JSON using jq
            VAULT_ID=$(echo "$VAULT_LIST_JSON" | jq -r '.data[]? | select(."display-name" == "homelab-secrets" or ."display-name" == "homelab-secrets-vault") | .id' 2>/dev/null | head -1 || echo "")

            if [[ -z "$VAULT_ID" || "$VAULT_ID" == "null" ]]; then
              echo "::warning::Vault 'homelab-secrets' not found by name, trying first vault in compartment..."
              VAULT_ID=$(echo "$VAULT_LIST_JSON" | jq -r '.data[0].id // empty' 2>/dev/null || echo "")
            fi

            if [[ -n "$VAULT_ID" && "$VAULT_ID" != "null" ]]; then
              echo "Found vault ID: ${VAULT_ID:0:50}..."

              # Get vault details to retrieve management endpoint
              # Try to get clean JSON first (stderr redirected)
              VAULT_JSON_RAW=$(oci kms management vault get \
                --vault-id "$VAULT_ID" \
                --raw-output 2>/dev/null || echo "")
              VAULT_GET_EXIT=$?

              # If that failed or output is empty, try with stderr included and filter warnings
              if [[ "$VAULT_GET_EXIT" -ne 0 ]] || [[ -z "$VAULT_JSON_RAW" ]]; then
                VAULT_JSON_RAW=$(oci kms management vault get \
                  --vault-id "$VAULT_ID" \
                  --raw-output 2>&1 | grep -v "^WARNING:" | grep -v "^To fix" | grep -v "^Alternatively" | grep -v "^export OCI_CLI" | grep -v "^oci setup repair" || true)
                VAULT_GET_EXIT=$?
              fi

              # Extract JSON from output (find the JSON object)
              VAULT_JSON=$(echo "$VAULT_JSON_RAW" | grep -E '^\s*\{' -A 1000 | head -100 | jq -c '.' 2>/dev/null || echo "$VAULT_JSON_RAW" | jq -c '.' 2>/dev/null || echo "")

              # If still empty, try to find JSON anywhere in output
              if [[ -z "$VAULT_JSON" ]]; then
                VAULT_JSON=$(echo "$VAULT_JSON_RAW" | jq -c '.' 2>/dev/null || echo "")
              fi

              if [[ "$VAULT_GET_EXIT" -eq 0 ]] && echo "$VAULT_JSON" | jq -e '.data' > /dev/null 2>&1; then
                VAULT_MGMT_ENDPOINT=$(echo "$VAULT_JSON" | jq -r '.data."management-endpoint" // empty' 2>/dev/null || echo "")

                if [[ -n "$VAULT_MGMT_ENDPOINT" && "$VAULT_MGMT_ENDPOINT" != "null" && "$VAULT_MGMT_ENDPOINT" != "" ]]; then
                  echo "Found vault management endpoint: ${VAULT_MGMT_ENDPOINT:0:50}..."
                  # Get key from vault using management endpoint
                  # Try to get clean JSON first (stderr redirected)
                  KEY_LIST_OUTPUT_RAW=$(oci kms management key list \
                    --compartment-id "$COMPARTMENT_ID" \
                    --endpoint "$VAULT_MGMT_ENDPOINT" \
                    --all \
                    --raw-output 2>/dev/null || echo "")
                  KEY_LIST_EXIT=$?

                  # If that failed or output is empty, try with stderr included and filter warnings
                  if [[ "$KEY_LIST_EXIT" -ne 0 ]] || [[ -z "$KEY_LIST_OUTPUT_RAW" ]]; then
                    KEY_LIST_OUTPUT_RAW=$(oci kms management key list \
                      --compartment-id "$COMPARTMENT_ID" \
                      --endpoint "$VAULT_MGMT_ENDPOINT" \
                      --all \
                      --raw-output 2>&1 | grep -v "^WARNING:" | grep -v "^To fix" | grep -v "^Alternatively" | grep -v "^export OCI_CLI" | grep -v "^oci setup repair" || true)
                    KEY_LIST_EXIT=$?
                  fi

                  # Extract JSON from output (find the JSON object)
                  KEY_LIST_OUTPUT=$(echo "$KEY_LIST_OUTPUT_RAW" | grep -E '^\s*\{' -A 1000 | head -100 | jq -c '.' 2>/dev/null || echo "$KEY_LIST_OUTPUT_RAW" | jq -c '.' 2>/dev/null || echo "")

                  # If still empty, try to find JSON anywhere in output
                  if [[ -z "$KEY_LIST_OUTPUT" ]]; then
                    KEY_LIST_OUTPUT=$(echo "$KEY_LIST_OUTPUT_RAW" | jq -c '.' 2>/dev/null || echo "")
                  fi

                  if [[ "$KEY_LIST_EXIT" -eq 0 ]] && echo "$KEY_LIST_OUTPUT" | jq -e '.data' > /dev/null 2>&1; then
                    KEY_ID=$(echo "$KEY_LIST_OUTPUT" | jq -r '.data[]? | select(."display-name" == "homelab-secrets-master-key" or ."display-name" == "homelab-secrets-key") | .id' 2>/dev/null | head -1 || echo "")

                    if [[ -z "$KEY_ID" || "$KEY_ID" == "null" ]]; then
                      KEY_ID=$(echo "$KEY_LIST_OUTPUT" | jq -r '.data[0].id // empty' 2>/dev/null || echo "")
                    fi
                  else
                    echo "::warning::Failed to list keys (exit code: $KEY_LIST_EXIT). Output: ${KEY_LIST_OUTPUT_RAW:0:300}..."
                    # Try to extract JSON even if there are warnings
                    EXTRACTED_KEY_JSON=$(echo "$KEY_LIST_OUTPUT_RAW" | grep -E '^\s*\{' -A 1000 | head -100 || echo "$KEY_LIST_OUTPUT_RAW" | tail -n +1)
                    if echo "$EXTRACTED_KEY_JSON" | jq -e '.data' > /dev/null 2>&1; then
                      echo "::notice::JSON found in key list output, retrying parsing..."
                      KEY_ID=$(echo "$EXTRACTED_KEY_JSON" | jq -r '.data[]? | select(."display-name" == "homelab-secrets-master-key" or ."display-name" == "homelab-secrets-key") | .id' 2>/dev/null | head -1 || echo "")
                      if [[ -z "$KEY_ID" || "$KEY_ID" == "null" ]]; then
                        KEY_ID=$(echo "$EXTRACTED_KEY_JSON" | jq -r '.data[0].id // empty' 2>/dev/null || echo "")
                      fi
                      if [[ -n "$KEY_ID" && "$KEY_ID" != "null" ]]; then
                        echo "::notice::Successfully extracted key ID: ${KEY_ID:0:50}..."
                      fi
                    fi
                  fi
                else
                  echo "::warning::Could not retrieve vault management endpoint from vault details"
                  echo "Vault JSON (first 500 chars): ${VAULT_JSON:0:500}..."
                fi
              else
                echo "::warning::Failed to get vault details (exit code: $VAULT_GET_EXIT). Output: ${VAULT_JSON_RAW:0:300}..."
                # Try to extract JSON even if there are warnings
                EXTRACTED_VAULT_JSON=$(echo "$VAULT_JSON_RAW" | grep -E '^\s*\{' -A 1000 | head -100 || echo "$VAULT_JSON_RAW" | tail -n +1)
                if echo "$EXTRACTED_VAULT_JSON" | jq -e '.data' > /dev/null 2>&1; then
                  echo "::notice::JSON found in vault details output, retrying parsing..."
                  VAULT_MGMT_ENDPOINT=$(echo "$EXTRACTED_VAULT_JSON" | jq -r '.data."management-endpoint" // empty' 2>/dev/null || echo "")
                  if [[ -n "$VAULT_MGMT_ENDPOINT" && "$VAULT_MGMT_ENDPOINT" != "null" && "$VAULT_MGMT_ENDPOINT" != "" ]]; then
                    echo "::notice::Successfully extracted management endpoint: ${VAULT_MGMT_ENDPOINT:0:50}..."
                    # Continue with this endpoint
                  fi
                fi
              fi
            else
              echo "::warning::No vault found in compartment"
              echo "Vault list output (first 500 chars): ${VAULT_LIST_JSON:0:500}..."
            fi
          else
            echo "::error::Failed to list vaults via OCI API (exit code: $VAULT_LIST_EXIT)"
            echo "Command output (first 1000 chars):"
            echo "${VAULT_LIST_OUTPUT:0:1000}"
            echo ""
            echo "Attempting to extract JSON from output..."
            # Try to extract JSON even if there are warnings
            EXTRACTED_JSON=$(echo "$VAULT_LIST_OUTPUT" | grep -E '^\s*\{' -A 1000 | head -100 || echo "$VAULT_LIST_OUTPUT" | tail -n +1)
            if echo "$EXTRACTED_JSON" | jq -e '.data' > /dev/null 2>&1; then
              echo "::notice::JSON found in output, retrying parsing..."
              VAULT_ID=$(echo "$EXTRACTED_JSON" | jq -r '.data[]? | select(."display-name" == "homelab-secrets" or ."display-name" == "homelab-secrets-vault") | .id' 2>/dev/null | head -1 || echo "")
              if [[ -z "$VAULT_ID" || "$VAULT_ID" == "null" ]]; then
                VAULT_ID=$(echo "$EXTRACTED_JSON" | jq -r '.data[0].id // empty' 2>/dev/null || echo "")
              fi
              if [[ -n "$VAULT_ID" && "$VAULT_ID" != "null" ]]; then
                echo "::notice::Successfully extracted vault ID: ${VAULT_ID:0:50}..."
                # Continue with this vault ID
              else
                echo "::error::Could not extract vault ID from JSON"
              fi
            else
              echo "::error::No valid JSON found in output"
              echo ""
              echo "::error::This might be due to:"
              echo "  1. Missing permissions (need KMS vault read permissions)"
              echo "  2. Invalid compartment ID: $COMPARTMENT_ID"
              echo "  3. OCI CLI authentication issue"
              echo ""
              echo "::error::To debug locally, run:"
              echo "  cd .github/actions/oci-vault-update-secret"
              echo "  ./test-local.sh"
              echo ""
              echo "::error::Or test manually:"
              echo "  oci kms management vault list --compartment-id $COMPARTMENT_ID"
            fi
          fi
        fi

        if [[ -z "$VAULT_ID" || -z "$KEY_ID" || "$VAULT_ID" == "null" || "$KEY_ID" == "null" ]]; then
          echo "::error::Could not determine Vault ID or Key ID."
          echo "::error::Tried:"
          echo "  1. Terraform state (directory: ${TF_DIR:-not found})"
          echo "  2. OCI API (compartment: $COMPARTMENT_ID)"
          echo "::error::Make sure the vault 'homelab-secrets' exists in OCI or Terraform state is accessible."
          exit 1
        fi

        echo "vault_id=$VAULT_ID" >> $GITHUB_OUTPUT
        echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT
        echo "compartment_id=$COMPARTMENT_ID" >> $GITHUB_OUTPUT
        echo "::notice::Using Vault: ${VAULT_ID:0:50}..."
        echo "::notice::Using Key: ${KEY_ID:0:50}..."

    - name: Update OCI Vault Secret
      id: update
      shell: bash
      env:
        SECRET_NAME: ${{ inputs.secret_name }}
        SECRET_VALUE: ${{ inputs.secret_value }}
        VAULT_ID: ${{ steps.vault-config.outputs.vault_id }}
        KEY_ID: ${{ steps.vault-config.outputs.key_id }}
        COMPARTMENT_ID: ${{ steps.vault-config.outputs.compartment_id }}
        OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: True
      run: |
        if [[ -z "$SECRET_VALUE" ]]; then
          echo "::warning::Secret value is empty, skipping update"
          exit 0
        fi

        # Mask the secret value in logs
        echo "::add-mask::$SECRET_VALUE"

        # Check if secret exists
        EXISTING_SECRET_OCID=$(oci vault secret list \
          --compartment-id "$COMPARTMENT_ID" \
          --name "$SECRET_NAME" \
          --lifecycle-state ACTIVE \
          --query 'data[0].id' \
          --raw-output 2>/dev/null || echo "")

        # Base64 encode the secret value
        SECRET_B64=$(echo -n "$SECRET_VALUE" | base64 -w0)

        if [[ -n "$EXISTING_SECRET_OCID" && "$EXISTING_SECRET_OCID" != "null" ]]; then
          echo "Updating existing secret: $SECRET_NAME"
          oci vault secret update-base64 \
            --secret-id "$EXISTING_SECRET_OCID" \
            --secret-content-content "$SECRET_B64" \
            --force
          echo "secret_ocid=$EXISTING_SECRET_OCID" >> $GITHUB_OUTPUT
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "::notice::✓ Secret updated: $SECRET_NAME"
        else
          echo "Creating new secret: $SECRET_NAME"
          RESULT=$(oci vault secret create-base64 \
            --compartment-id "$COMPARTMENT_ID" \
            --vault-id "$VAULT_ID" \
            --key-id "$KEY_ID" \
            --secret-name "$SECRET_NAME" \
            --secret-content-content "$SECRET_B64" \
            --query 'data.id' \
            --raw-output)
          echo "secret_ocid=$RESULT" >> $GITHUB_OUTPUT
          echo "updated=false" >> $GITHUB_OUTPUT
          echo "::notice::✓ Secret created: $SECRET_NAME"
        fi
