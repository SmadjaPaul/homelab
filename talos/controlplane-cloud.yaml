# Talos Linux - Control Plane for CLOUD cluster (Oracle Cloud)
# Story: 3.2.2 - Bootstrap CLOUD Cluster
# For OCI + Omni: use the image generated by Omni UI (pre-configured); see
# https://blog.zwindler.fr/2025/01/04/sideros-omni-talos-oracle-cloud/
# This file is reference only (manual config or non-Omni flow).
# Replace CONTROL_PLANE_IP with terraform output k8s_nodes[0].public_ip
# Replace <CLUSTER_SECRET> with: talosctl gen secrets
# Replace <JOIN_TOKEN> with token from Omni (cluster name: cloud)

version: v1alpha1
machine:
  type: controlplane

  network:
    hostname: oci-node-1
    interfaces:
      - interface: eth0
        addresses:
          - 10.0.1.10/24  # Replace with actual private IP from OCI (or use DHCP)
        routes:
          - network: 0.0.0.0/0
            gateway: 10.0.1.1
        mtu: 1500
    nameservers:
      - 1.1.1.1
      - 8.8.8.8

  install:
    disk: /dev/sda
    image: ghcr.io/siderolabs/installer:v1.12.1
    bootloader: true
    wipe: false

  time:
    servers:
      - time.cloudflare.com
      - pool.ntp.org

  # Omni: set joinToken from Omni UI (cluster "cloud")
  omni:
    enabled: true
    url: https://omni.smadja.dev
    joinToken: <JOIN_TOKEN>

  kubelet:
    extraArgs:
      max-pods: "110"
      node-ip: "10.0.1.10"  # Match control plane IP above

cluster:
  id: homelab-cloud
  secret: <CLUSTER_SECRET>

  controlplane:
    endpoint: https://CONTROL_PLANE_IP:6443  # Replace with oci-node-1 public IP

  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

  network:
    dnsDomain: cluster.local
    podSubnet: 10.244.0.0/16
    serviceSubnet: 10.96.0.0/12

  apiServer:
    certSANs:
      - CONTROL_PLANE_IP
      - 10.0.1.10
      - oci-node-1
      - oci-node-1.cluster.local
    extraArgs:
      audit-log-maxage: "30"
      audit-log-maxbackup: "3"
      audit-log-maxsize: "100"
      audit-log-path: /var/log/audit.log

  controllerManager:
    extraArgs:
      bind-address: "0.0.0.0"

  scheduler:
    extraArgs:
      bind-address: "0.0.0.0"

  etcd:
    extraArgs:
      listen-metrics-urls: "http://0.0.0.0:2381"

  proxy:
    disabled: false
    image: ghcr.io/siderolabs/kube-proxy:v1.35.0
